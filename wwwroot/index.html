<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MDG Mobile</title>
<style>
body{font-family:Arial;margin:10px}
input,select,textarea,button{width:100%;margin:5px 0;padding:8px}
.ok{color:green}
.err{color:red}
li{margin:6px 0}
.machine{font-weight:bold}
.tache{font-style:italic;font-size:0.9em}
</style>

<script>
if('Notification' in window){ Notification.requestPermission(); }
function notify(msg){
  if(Notification.permission==="granted"){
    new Notification("MDG Maintenance", { body: msg });
  }
}
</script>
</head>

<body>

<h2>MDG Mobile</h2>

<label>Utilisateur</label>
<input id="user" placeholder="Nom"/>

<label>Machine</label>
<input id="machine" placeholder="Machine"/>

<label>Type</label>
<select id="type">
  <option>Entretien</option>
  <option>Panne</option>
</select>

<label>Description</label>
<textarea id="desc"></textarea>

<button onclick="send()">Envoyer</button>
<p id="msg"></p>

<hr>
<h3>Entretiens à faire</h3>
<button onclick="loadPreventif()">Actualiser</button>
<ul id="pList"></ul>

<script>
function send(){
  const data = {
    user: user.value,
    machine: machine.value,
    type: type.value,
    desc: desc.value,
    date: new Date().toISOString().substring(0,10)
  };

  fetch("/add",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  })
  .then(r=>r.ok?"OK":"Erreur")
  .then(_=>msg.innerHTML="<span class='ok'>Envoyé ✅</span>")
  .catch(_=>msg.innerHTML="<span class='err'>Hors ligne ❌</span>");
}

function loadPreventif(){
  fetch("/preventif")
  .then(r=>r.json())
  .then(list=>{
    pList.innerHTML="";
    let today = new Date().toISOString().substring(0,10);

    list.forEach(i=>{
      let uid = (i.machine || "").replace(/\s+/g,'_');

      let li = document.createElement("li");
      li.innerHTML = `
        <div class="machine">${i.machine}</div>
        ${i.type} - ${i.prochaine}<br>
        <div class="tache">${i.tache || ""}</div>
        <select id="op_${uid}">
          <option>Mostapha</option>
          <option>Jawad</option>
          <option>Abdelillah</option>
        </select>
        <button onclick="valider('${i.machine}','${(i.tache||"").replace(/'/g,"\\'")}')">✅ Valider</button>
        <hr>
      `;
      pList.appendChild(li);

      if(i.prochaine <= today){
        notify("Entretien : " + i.machine + " — " + (i.tache||""));
      }
    });
  });
}

function valider(machine, tache){
  let uid = (machine || "").replace(/\s+/g,'_');
  let op = document.getElementById("op_"+uid).value;

  let payload = {
    machine: machine,
    operateur: op,
    tache: tache,
    date: new Date().toISOString().substring(0,10)
  };

  fetch("/validate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(_=>alert("✅ Entretien validé par " + op))
}
</script>

</body>
</html>

