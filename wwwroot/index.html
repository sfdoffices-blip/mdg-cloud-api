<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MDG Mobile</title>
<style>
body{font-family:Arial;margin:10px}
input,select,textarea,button{width:100%;margin:6px 0;padding:8px}
.ok{color:green}
.err{color:red}
li{margin:8px 0}
.machine{font-weight:bold}
.tache{font-style:italic;font-size:0.9em}
</style>
</head>
<body>

<h2>MDG Mobile</h2>

<label>Utilisateur</label>
<select id="user"></select>

<label>Machine</label>
<select id="machine"></select>

<label>Type</label>
<select id="type">
  <option>Entretien</option>
  <option>Panne</option>
</select>

<label>Description</label>
<textarea id="desc"></textarea>

<button onclick="send()">Envoyer</button>
<p id="msg"></p>

<hr>
<h3>Entretiens à faire</h3>
<button onclick="loadPreventif()">Actualiser</button>
<ul id="pList"></ul>

<script>
function fillSelect(url, selectId){
  fetch(url).then(r=>r.json()).then(list=>{
    let s = document.getElementById(selectId);
    s.innerHTML = "";
    list.forEach(i=>{
      let o = document.createElement("option");
      o.text=i; o.value=i; s.add(o);
    });
  });
}

fillSelect("/users","user");
fillSelect("/machines","machine");

function send(){
  const data = {
    user: user.value,
    machine: machine.value,
    type: type.value,
    desc: desc.value,
    date: new Date().toISOString().substring(0,10)
  };

  fetch("/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)})
    .then(_=>msg.innerHTML="<span class='ok'>Envoyé ✅</span>")
    .catch(_=>msg.innerHTML="<span class='err'>Erreur ❌</span>");
}

function loadPreventif(){
  fetch("/preventif").then(r=>r.json()).then(list=>{
    pList.innerHTML="";
    list.forEach(i=>{
      let id = (i.machine||"").replace(/\s+/g,"_");
      let li = document.createElement("li");
      li.innerHTML = `
        <div class="machine">${i.machine}</div>
        ${i.type} - ${i.prochaine}<br>
        <div class="tache">${i.tache||""}</div>
        <select id="op_${id}"></select>
        <button onclick="valider('${i.machine}','${(i.tache||"").replace(/'/g,"\\'")}')">✅ Valider</button>
        <hr>`;
      pList.appendChild(li);
      fillSelect("/users","op_"+id);
    });
  });
}

function valider(machine, tache){
  let id = machine.replace(/\s+/g,"_");
  let op = document.getElementById("op_"+id).value;

  let payload = { machine, operateur: op, tache, date: new Date().toISOString().substring(0,10) };
  fetch("/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
    .then(()=>{ alert("✅ Validé"); loadPreventif(); });
}
</script>

</body>
</html>

